using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Runtime.CompilerServices;
using NLog;
using Sandbox.Engine.Multiplayer;
using Sandbox.Game.Entities;
using Sandbox.Game.Entities.Cube;
using Sandbox.Game.Gui;
using Sandbox.Game.Multiplayer;
using Sandbox.Game.World;
using SpaceEngineers.Game.Entities.Blocks.SafeZone;
using Torch.Managers.PatchManager;
using VRage.Game;
using VRage.Game.Entity;
using VRage.Game.ModAPI;
using VRage.Network;
using VRageMath;

namespace ExploitFixer.ExploitFixer.Patches
{
	[PatchShim]
	public static class EntityListResponsePatch
	{
		[CompilerGenerated]
		private sealed class Class6
		{
			public MySafeZoneBlock mySafeZoneBlock_0;

			public Action<List<MyEntityListShortInfoItem>> action_0;

			internal T0 method_0<T0, T1>(T1 gparam_0)
			{
				//IL_0017: Expected O, but got I4
				return (T0)(smethod_0((MyEntity)gparam_0) != smethod_0((MyEntity)(object)mySafeZoneBlock_0));
			}

			internal T0 method_1<T0, T1>(T1 gparam_0)
			{
				return (T0)action_0;
			}

			static long smethod_0(MyEntity myEntity_0)
			{
				return myEntity_0.EntityId;
			}
		}

		public static Logger _log = smethod_19(global::_003CModule_003E.smethod_5<string>(1078789792));

		public static void Patch(PatchContext ctx)
		{
			MethodInfo methodBase_ = default(MethodInfo);
			while (true)
			{
				int num = -1986301828;
				while (true)
				{
					switch ((uint)(num ^ -1582003042) % 3u)
					{
					case 1u:
						goto IL_0003;
					case 0u:
						break;
					default:
						smethod_3(smethod_2(smethod_1(ctx, (MethodBase)methodBase_)), ((EntityListResponsePatch)(object)smethod_0(typeof(EntityListResponsePatch).TypeHandle)).method_0(global::_003CModule_003E.smethod_2<string>(971024884), BindingFlags.Static | BindingFlags.Public));
						return;
					}
					break;
					IL_0003:
					methodBase_ = ((EntityListResponsePatch)(object)smethod_0(typeof(MyGuiScreenSafeZoneFilter).TypeHandle)).method_0(global::_003CModule_003E.smethod_4<string>(1593616735), BindingFlags.Static | BindingFlags.NonPublic);
					num = -751846012;
				}
			}
		}

		public static bool EntityListRequestPrefix(MyEntityTypeEnum selectedType)
		{
			//IL_0000: Unknown result type (might be due to invalid IL or missing references)
			//IL_0005: Unknown result type (might be due to invalid IL or missing references)
			//IL_0035: Unknown result type (might be due to invalid IL or missing references)
			//IL_003a: Unknown result type (might be due to invalid IL or missing references)
			//IL_003c: Unknown result type (might be due to invalid IL or missing references)
			//IL_003f: Invalid comparison between Unknown and I4
			ulong value = MyEventContext.Current.Sender.Value;
			MyPlayer myPlayer_ = default(MyPlayer);
			MyPlayer val = (smethod_5(smethod_4().Players, value, ref myPlayer_) ? myPlayer_ : null);
			if (val != null)
			{
				MyPromoteLevel val2 = smethod_6(smethod_4(), value);
				if ((int)val2 == 0)
				{
					return false;
				}
				return true;
			}
			return false;
		}

		public static bool EntityListRequestPrefix2(MyEntityTypeEnum selectedType)
		{
			//IL_0016: Unknown result type (might be due to invalid IL or missing references)
			//IL_001b: Unknown result type (might be due to invalid IL or missing references)
			//IL_0053: Unknown result type (might be due to invalid IL or missing references)
			//IL_0196: Unknown result type (might be due to invalid IL or missing references)
			//IL_019b: Unknown result type (might be due to invalid IL or missing references)
			//IL_01aa: Unknown result type (might be due to invalid IL or missing references)
			//IL_01ac: Unknown result type (might be due to invalid IL or missing references)
			Class6 @class = new Class6();
			List<MyEntityListShortInfoItem> list = (List<MyEntityListShortInfoItem>)Activator.CreateInstance(typeof(List<MyEntityListShortInfoItem>));
			ulong value = MyEventContext.Current.Sender.Value;
			MyPlayer myPlayer_ = default(MyPlayer);
			MyPlayer val = (smethod_5(smethod_4().Players, value, ref myPlayer_) ? myPlayer_ : null);
			if (val == null)
			{
				return false;
			}
			BoundingSphereD boundingSphereD_ = default(BoundingSphereD);
			((BoundingSphereD)(ref boundingSphereD_))._002Ector(smethod_7(val), 500.0);
			@class.mySafeZoneBlock_0 = smethod_8(ref boundingSphereD_).OfType<MySafeZoneBlock>().FirstOrDefault();
			if (@class.mySafeZoneBlock_0 == null)
			{
				smethod_11(_log, smethod_10(smethod_9(val), global::_003CModule_003E.smethod_4<string>(1948131250)));
				return false;
			}
			if (smethod_13((MyTerminalBlock)(object)@class.mySafeZoneBlock_0, smethod_12(smethod_4()), (MyRelationsBetweenPlayerAndBlock)0))
			{
				if (smethod_14((MyFunctionalBlock)(object)@class.mySafeZoneBlock_0))
				{
					List<MyCubeGrid> list2 = smethod_8(ref boundingSphereD_).OfType<MyCubeGrid>().Where(@class.method_0<bool, MyCubeGrid>).ToList();
					foreach (MyCubeGrid item2 in list2)
					{
						MyEntityListShortInfoItem obj = smethod_15();
						obj.DisplayName = smethod_16((MyEntity)(object)item2);
						obj.EntityId = smethod_17((MyEntity)(object)item2);
						MyEntityListShortInfoItem item = obj;
						list.Add(item);
					}
					MethodInfo methodInfo_ = ((EntityListResponsePatch)(object)smethod_0(typeof(MyGuiScreenSafeZoneFilter).TypeHandle)).method_0(global::_003CModule_003E.smethod_5<string>(1248352982), BindingFlags.Static | BindingFlags.NonPublic);
					@class.action_0 = (Action<List<MyEntityListShortInfoItem>>)smethod_18(smethod_0(typeof(Action<List<MyEntityListShortInfoItem>>).TypeHandle), (object)null, methodInfo_);
					MyEventContext current2 = MyEventContext.Current;
					MyMultiplayer.RaiseStaticEvent<List<MyEntityListShortInfoItem>>((Func<IMyEventOwner, Action<List<MyEntityListShortInfoItem>>>)@class.method_1<Action<List<MyEntityListShortInfoItem>>, IMyEventOwner>, list, current2.Sender, (Vector3D?)null);
					return false;
				}
				smethod_11(_log, smethod_10(smethod_9(val), global::_003CModule_003E.smethod_4<string>(1743886502)));
				return false;
			}
			smethod_11(_log, smethod_10(smethod_9(val), global::_003CModule_003E.smethod_4<string>(1743886502)));
			return false;
		}

		static Type smethod_0(RuntimeTypeHandle runtimeTypeHandle_0)
		{
			return Type.GetTypeFromHandle(runtimeTypeHandle_0);
		}

		MethodInfo method_0(string string_0, BindingFlags bindingFlags_0)
		{
			return ((Type)this).GetMethod(string_0, bindingFlags_0);
		}

		static MethodRewritePattern smethod_1(PatchContext patchContext_0, MethodBase methodBase_0)
		{
			return patchContext_0.GetPattern(methodBase_0);
		}

		static MethodRewritePattern.MethodRewriteSet smethod_2(MethodRewritePattern methodRewritePattern_0)
		{
			return methodRewritePattern_0.Prefixes;
		}

		static bool smethod_3(MethodRewritePattern.MethodRewriteSet methodRewriteSet_0, MethodInfo methodInfo_0)
		{
			return methodRewriteSet_0.Add(methodInfo_0);
		}

		static MySession smethod_4()
		{
			return MySession.Static;
		}

		static bool smethod_5(MyPlayerCollection myPlayerCollection_0, ulong ulong_0, ref MyPlayer myPlayer_0)
		{
			return myPlayerCollection_0.TryGetPlayerBySteamId(ulong_0, ref myPlayer_0);
		}

		static MyPromoteLevel smethod_6(MySession mySession_0, ulong ulong_0)
		{
			//IL_0002: Unknown result type (might be due to invalid IL or missing references)
			return mySession_0.GetUserPromoteLevel(ulong_0);
		}

		static Vector3D smethod_7(MyPlayer myPlayer_0)
		{
			//IL_0001: Unknown result type (might be due to invalid IL or missing references)
			return myPlayer_0.GetPosition();
		}

		static List<MyEntity> smethod_8(ref BoundingSphereD boundingSphereD_0)
		{
			return MyEntities.GetEntitiesInSphere(ref boundingSphereD_0);
		}

		static string smethod_9(MyPlayer myPlayer_0)
		{
			return myPlayer_0.DisplayName;
		}

		static string smethod_10(string string_0, string string_1)
		{
			return string_0 + string_1;
		}

		static void smethod_11(Logger logger_0, string string_0)
		{
			logger_0.Warn(string_0);
		}

		static long smethod_12(MySession mySession_0)
		{
			return mySession_0.LocalPlayerId;
		}

		static bool smethod_13(MyTerminalBlock myTerminalBlock_0, long long_0, MyRelationsBetweenPlayerAndBlock myRelationsBetweenPlayerAndBlock_0)
		{
			//IL_0002: Unknown result type (might be due to invalid IL or missing references)
			return myTerminalBlock_0.HasPlayerAccess(long_0, myRelationsBetweenPlayerAndBlock_0);
		}

		static bool smethod_14(MyFunctionalBlock myFunctionalBlock_0)
		{
			return myFunctionalBlock_0.Enabled;
		}

		static MyEntityListShortInfoItem smethod_15()
		{
			return (MyEntityListShortInfoItem)Activator.CreateInstance(typeof(MyEntityListShortInfoItem));
		}

		static string smethod_16(MyEntity myEntity_0)
		{
			return myEntity_0.DisplayName;
		}

		static long smethod_17(MyEntity myEntity_0)
		{
			return myEntity_0.EntityId;
		}

		static Delegate smethod_18(Type type_0, object object_0, MethodInfo methodInfo_0)
		{
			return Delegate.CreateDelegate(type_0, object_0, methodInfo_0);
		}

		static Logger smethod_19(string string_0)
		{
			return LogManager.GetLogger(string_0);
		}
	}
}
